/**
 * Adapted from https://github.com/HarryStevens/d3-regression
 */
import { determination } from './utils/determination.js';
import { interpose } from './utils/interpose.js';
import { ols } from './utils/ols.js';
import { visitPoints } from './utils/points.js';
export default function logarithmic() {
    let x = (d) => d[0], y = (d) => d[1], base = Math.E, domain;
    const logarithmicRegression = function (data) {
        let n = 0, X = 0, Y = 0, XY = 0, X2 = 0, xmin = domain ? +domain[0] : Infinity, xmax = domain ? +domain[1] : -Infinity, lb = Math.log(base);
        visitPoints(data, x, y, (dx, dy) => {
            const lx = Math.log(dx) / lb;
            ++n;
            X += (lx - X) / n;
            Y += (dy - Y) / n;
            XY += (lx * dy - XY) / n;
            X2 += (lx * lx - X2) / n;
            if (!domain) {
                if (dx < xmin)
                    xmin = dx;
                if (dx > xmax)
                    xmax = dx;
            }
        });
        const [intercept, slope] = ols(X, Y, XY, X2);
        const fn = (xx) => (slope * Math.log(xx)) / lb + intercept;
        const out = interpose(xmin, xmax, fn);
        out.a = slope;
        out.b = intercept;
        out.predict = fn;
        out.rSquared = determination(data, x, y, Y, fn);
        return out;
    };
    logarithmicRegression.domain = function (arr) {
        if (!arguments.length)
            return domain;
        domain = arr;
        return logarithmicRegression;
    };
    logarithmicRegression.x = function (fn) {
        if (!arguments.length)
            return x;
        x = fn;
        return logarithmicRegression;
    };
    logarithmicRegression.y = function (fn) {
        if (!arguments.length)
            return y;
        y = fn;
        return logarithmicRegression;
    };
    logarithmicRegression.base = function (b) {
        if (!arguments.length)
            return base;
        base = b;
        return logarithmicRegression;
    };
    return logarithmicRegression;
}
